# ============================================================================
# Generic Validation & Promotion Framework - Master Configuration
# ============================================================================
# CTB Branch: data/validation-framework
# Barton ID: 05.03.00
# Purpose: Schema-agnostic validation config for Neon → Supabase → Promotion
# Last Updated: 2025-11-07
# ============================================================================

# Global Settings
global:
  batch_size: 100
  dry_run: false
  log_level: INFO
  enable_cost_tracking: true
  enable_time_tracking: true

  # Database Connections (read from .env)
  neon:
    connection_string_env: NEON_DATABASE_URL
    pool_size: 10

  supabase:
    connection_string_env: SUPABASE_DATABASE_URL
    api_key_env: SUPABASE_API_KEY
    pool_size: 5

  # Notification Settings
  notifications:
    webhook_url_env: LOVABLE_WEBHOOK_URL
    slack_webhook_env: SLACK_WEBHOOK_URL
    notify_on_failure: true
    notify_on_promotion: false

# ============================================================================
# Entity Definitions
# ============================================================================
# Add new entities here - framework handles the rest automatically
# ============================================================================

entities:

  # ──────────────────────────────────────────────────────────────
  # Company Entity
  # ──────────────────────────────────────────────────────────────
  company:
    enabled: true
    description: "Company data validation and promotion pipeline"

    # Neon Source & Target
    source_table: "intake.company_raw_intake"
    target_table: "marketing.company_master"
    key_field: "unique_id"

    # Supabase Workspace
    workspace_table: "company_needs_enrichment"
    workspace_schema: "public"

    # Field Mapping (source → target)
    field_mapping:
      company_name: company_name
      industry: industry
      employee_count: employee_count
      revenue: revenue
      website: website
      linkedin_url: linkedin_url
      phone: phone
      address: address
      city: city
      state: state
      postal_code: postal_code
      unique_id: company_unique_id

    # Validation Rules
    rules:
      - field: company_name
        rule: not_null
        severity: critical
        error_message: "Company name is required"

      - field: company_name
        rule: min_length
        params: { length: 2 }
        severity: critical
        error_message: "Company name must be at least 2 characters"

      - field: website
        rule: starts_with
        params: { prefix: "http" }
        severity: warning
        error_message: "Website should start with http:// or https://"
        auto_fix: true
        auto_fix_value: "https://{value}"

      - field: linkedin_url
        rule: contains
        params: { substring: "linkedin.com/company/" }
        severity: warning
        error_message: "LinkedIn URL should contain 'linkedin.com/company/'"

      - field: email
        rule: email_format
        severity: critical
        error_message: "Invalid email format"

      - field: employee_count
        rule: positive_integer
        severity: warning
        error_message: "Employee count must be positive integer"

      - field: revenue
        rule: positive_number
        severity: warning
        error_message: "Revenue must be positive number"

    # Promotion Settings
    promotion:
      require_all_critical: true
      allow_warnings: true
      update_existing: true
      conflict_resolution: "prefer_new"

    # Enrichment Settings
    enrichment:
      required_fields: ["website", "linkedin_url"]
      agents: ["apify", "abacus", "firecrawl"]
      max_retry: 3

  # ──────────────────────────────────────────────────────────────
  # Person Entity
  # ──────────────────────────────────────────────────────────────
  person:
    enabled: true
    description: "Contact/person data validation and promotion pipeline"

    # Neon Source & Target
    source_table: "intake.people_raw_intake"
    target_table: "marketing.people_master"
    key_field: "unique_id"

    # Supabase Workspace
    workspace_table: "people_needs_enrichment"
    workspace_schema: "public"

    # Field Mapping
    field_mapping:
      first_name: first_name
      last_name: last_name
      full_name: full_name
      email: email
      phone: phone
      title: title
      linkedin_url: linkedin_url
      company_unique_id: company_unique_id
      unique_id: person_unique_id

    # Validation Rules
    rules:
      - field: first_name
        rule: not_null
        severity: critical
        error_message: "First name is required"

      - field: last_name
        rule: not_null
        severity: critical
        error_message: "Last name is required"

      - field: email
        rule: contains
        params: { substring: "@" }
        severity: critical
        error_message: "Email must contain @"

      - field: email
        rule: email_format
        severity: critical
        error_message: "Invalid email format"

      - field: linkedin_url
        rule: contains
        params: { substring: "linkedin.com/in/" }
        severity: warning
        error_message: "LinkedIn URL should contain 'linkedin.com/in/'"

      - field: phone
        rule: phone_format
        severity: warning
        error_message: "Invalid phone format"

    # Promotion Settings
    promotion:
      require_all_critical: true
      allow_warnings: true
      update_existing: true
      conflict_resolution: "prefer_new"

    # Enrichment Settings
    enrichment:
      required_fields: ["email", "linkedin_url"]
      agents: ["apollo", "clearbit", "lusha"]
      max_retry: 3

# ============================================================================
# Validation Rule Definitions
# ============================================================================
# Built-in rules that can be used across all entities
# ============================================================================

rule_definitions:

  # Basic Rules
  not_null:
    description: "Field must not be null or empty"
    applies_to: ["string", "number", "any"]

  min_length:
    description: "String must have minimum length"
    applies_to: ["string"]
    params_required: ["length"]

  max_length:
    description: "String must not exceed maximum length"
    applies_to: ["string"]
    params_required: ["length"]

  # Pattern Rules
  starts_with:
    description: "String must start with prefix"
    applies_to: ["string"]
    params_required: ["prefix"]

  ends_with:
    description: "String must end with suffix"
    applies_to: ["string"]
    params_required: ["suffix"]

  contains:
    description: "String must contain substring"
    applies_to: ["string"]
    params_required: ["substring"]

  regex_match:
    description: "String must match regex pattern"
    applies_to: ["string"]
    params_required: ["pattern"]

  # Format Rules
  email_format:
    description: "Must be valid email format"
    applies_to: ["string"]
    regex: "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$"

  phone_format:
    description: "Must be valid phone format"
    applies_to: ["string"]
    regex: "^\\+?1?\\d{9,15}$"

  url_format:
    description: "Must be valid URL format"
    applies_to: ["string"]
    regex: "^https?://[^\\s]+$"

  # Number Rules
  positive_integer:
    description: "Must be positive integer"
    applies_to: ["number"]

  positive_number:
    description: "Must be positive number (int or float)"
    applies_to: ["number"]

  in_range:
    description: "Number must be within range"
    applies_to: ["number"]
    params_required: ["min", "max"]

  # Custom Rules
  custom_function:
    description: "Run custom validation function"
    applies_to: ["any"]
    params_required: ["function_name"]

# ============================================================================
# Logging Configuration
# ============================================================================

logging:
  # Validation Log Settings
  validation_log_table: "validation_log"
  validation_log_schema: "public"
  log_retention_days: 90

  # Audit Trail
  audit_trail_table: "audit_trail"
  audit_trail_schema: "public"
  track_all_operations: true

  # Error Categorization
  error_categories:
    CRITICAL: "Blocks promotion, requires fix"
    WARNING: "Allows promotion, should review"
    INFO: "Informational only"

# ============================================================================
# Performance Settings
# ============================================================================

performance:
  # Batch Processing
  max_batch_size: 1000
  min_batch_size: 10
  concurrent_batches: 3

  # Timeouts
  query_timeout_seconds: 30
  validation_timeout_seconds: 60
  promotion_timeout_seconds: 120

  # Retry Logic
  max_retries: 3
  retry_delay_seconds: 5
  exponential_backoff: true

# ============================================================================
# Cost Tracking
# ============================================================================

cost_tracking:
  enabled: true
  cost_per_validation: 0.001  # USD
  cost_per_promotion: 0.002   # USD
  cost_per_enrichment: 0.05   # USD
  currency: "USD"

# ============================================================================
# Doctrine Compliance
# ============================================================================

doctrine:
  barton_id_format: "NN.NN.NN.NN.NNNNN.NNN"
  enforce_barton_ids: true
  require_audit_trail: true
  require_timestamp_tracking: true

  # Data Quality Gates
  quality_gates:
    minimum_pass_rate: 0.80  # 80% must pass validation
    maximum_error_rate: 0.10  # 10% max errors
    block_on_critical_errors: true
