name: HEIR Compliance Audit

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop


jobs:
  heir-compliance:
    runs-on: ubuntu-latest
    name: HEIR Doctrine Compliance Validation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt 2>/dev/null || pip install pyyaml pydantic

      - name: Verify heir.doctrine.yaml
        run: |
          if [ ! -f "heir.doctrine.yaml" ]; then
            echo "❌ heir.doctrine.yaml not found"
            exit 1
          fi

          echo "✅ heir.doctrine.yaml found"
          cat heir.doctrine.yaml

      - name: Run HEIR Checks
        run: |
          if [ -f "packages/heir/checks.py" ]; then
            python -m packages.heir.checks
          elif [ -f "tools/heir_validator.py" ]; then
            python tools/heir_validator.py
          else
            echo "⚠️  No HEIR validation script found - skipping"
          fi

      - name: Generate Compliance Report
        if: always()
        run: |
          echo "=== HEIR Compliance Report ===" > compliance_report.txt
          echo "Generated: $(date)" >> compliance_report.txt
          echo "Repository: ${{ github.repository }}" >> compliance_report.txt
          echo "Branch: ${{ github.ref_name }}" >> compliance_report.txt
          echo "" >> compliance_report.txt

          echo "Files Checked:" >> compliance_report.txt
          echo "- heir.doctrine.yaml" >> compliance_report.txt
          echo "- CLAUDE.md" >> compliance_report.txt
          echo "- DOCTRINE.md" >> compliance_report.txt
          echo "- CONSTITUTION.md" >> compliance_report.txt

          cat compliance_report.txt

      - name: Upload Compliance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: heir-compliance-report
          path: compliance_report.txt
